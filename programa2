#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <stdlib.h>
#include <windows.h>
#include <locale.h>
#include <conio.h>

#define MAX 80
#define ARCHIVO_USUARIOS "usuarios.dat"
#define TECLA_ENTER 13
#define TECLA_BACKSPACE 8
#define LONGITUD 5
#define MAX_INTENTOS 3



struct jugador {

	char nombre_jugador[MAX];
	int puntuacionjugador;
	int dificultad;
	int pregunta_actual;
};


/* Estructura de cuentas de usuario */
struct usuario {
	char nombre[MAX];
	char password[MAX];
};

typedef struct usuario Usuario;

/* Funciones de menú */
void menuInicial();
void menuListarUsuarios();
void menuRegistrarUsuario();
void menuIniciarSesion();
void menuSistema();
void reglas();

/* Funciones que manipulan el archivo de usuarios */
char insertarUsuario(Usuario usuario);
char existeUsuario(char nombreUsuario[], Usuario *usuario);
Usuario *obtenerUsuarios(int *);
char logear(char nombreUsuario[], char password[]);

int leerLinea(char *cad, int n);
void leerClave(char *password);

void datoswombat();
void preguntas_facil(int pregunta_actual);
int respuestas_facil(int numero_pregunta, int respuesta_jugador);
void preguntas_dificil(int pregunta_actual);
int respuestas_dificil(int numero_pregunta, int respuesta_jugador);

char linea[MAX];


int main() {
	menuInicial();
	return 0;
}

void reglas() {
	printf("\n");
	printf("\n");
	printf("Reglas del juego.\n");
	printf("Para inciar tu partida en WOMBAT YINCANA, debes regristrarte o iniciar sesion si ya tienes una cuenta.\n");
	printf("El juego consta de 5 pruebas divididas en 5 preguntas cada una.\n");
	printf("A medida que vayas respondiendo correctamente cada pregunta, se iran sumando tus puntos.\n");
	printf("Las cuatro primeras preguntas tienen un valor de 5 puntos y la ultima de 10.\n");
	printf("Para poder continuar con las siguientes pruebas, debes acumular un total minimo de 10 puntos.\n");
	printf("\n");
	printf("MUCHA SUERTE Y QUE COMIENCE EL JUEGO!\n ");
	printf("\n");
	printf("\n");

}

void menuInicial() {

	setlocale(LC_CTYPE, "Spanish");//CODIFICAMOS EL IDIOMA A ESPAÑOL PARA PODER UTILIZAR LETRAS COMO LA Ñ DE ESPAÑA

	Usuario usuario;
	char repite = 1;
	int opcion = -1;
	int farandul;
	farandul = 1;
	system("color e0");//CODIFICAMOS EL COLOR: AMARILLO PARA EL FONDO Y EL NEGRO PARA LAS LETRAS


	do {
		system("cls");

		if (farandul == 1) {
			banner();
		}
		else {
			banner_fijo();
		}

		printf("\t\t\tMENU PRINCIPAL\n");
		printf("\n\t\t[1]. Ver jugadores registrados\n");
		printf("\t\t[2]. Registrar jugador nuevo\n");
		printf("\t\t[3]. Jugar\n");
		printf("\t\t[4]. Reglas del juego\n");
		printf("\t\t[5]. A cerca de los WOMBAT\n");
		printf("\t\t[0]. Salir\n");
		printf("\n\t\tIngrese su opcion: [ ]\b\b");
		leerLinea(linea, MAX);
		sscanf(linea, "%d", &opcion);
		farandul++;

		switch (opcion) {
		case 1:
			system("cls");
			banner_fijo();
			menuListarUsuarios();
			farandul++;
			break;

		case 2:
			system("cls");
			banner_fijo();
			menuRegistrarUsuario();
			farandul++;
			break;

		case 3:
			system("cls");
			banner_fijo();
			menuIniciarSesion();
			farandul++;
			break;

		case 4:
			system("cls");
			banner_fijo();
			reglas();
			system("pause");
			break;

		case 5:
			system("cls");
			banner_fijo();
			datoswombat();
			system("pause");
			farandul++;
			break;

		case 0:
			system("cls");
			banner_fijo();
			printf("HASTA PRONTO!!\n");
			repite = 0;
			break;
		}

	} while (repite == 1);
}

void menuRegistrarUsuario() {
	Usuario usuario;
	char nombreUsuario[MAX];
	char respuesta[MAX];
	char repite = 1;

	do {
		system("cls");
		printf("\n\t\t\tREGISTRAR JUGADOR\n");
		printf("\t\t\t=================\n");
		printf("\n\tIngrese nombre de usuario: ");
		leerLinea(linea, MAX);
		sscanf(linea, "%s", nombreUsuario);

		/* Se verifica que el nombre de usuario no exista */
		if (!existeUsuario(nombreUsuario, &usuario)) {
			strcpy(usuario.nombre, nombreUsuario);

			printf("\tIngrese la clave: ");
			leerLinea(usuario.password, MAX);

			/* Se inserta el usuario en el archivo de usuarios */
			if (insertarUsuario(usuario)) {
				printf("\n\tEl jugador fue registrado satisfactoriamente!\n");

			}
			else {
				printf("\n\tOcurrio un error al registrar el jugador\n");
				printf("\nInténtelo mas tarde\n");
			}
		}
		else {
			printf("\n\tEl usuario \"%s\" ya ha sido registrado previamente\n", usuario.nombre);
			printf("\tNo puede registrar dos usuarios con el mismo nombre de usuario.\n");
		}

		printf("\n\tDesea seguir registrando usuarios? [S/N]: ");
		leerLinea(respuesta, MAX);

		if (!(strcmp(respuesta, "S") == 0 || strcmp(respuesta, "s") == 0)) {
			repite = 0;
		}

	} while (repite == 1);
}

void menuListarUsuarios() {
	int numeroUsuarios;
	Usuario *usuarios;
	int i;

	system("cls");
	usuarios = obtenerUsuarios(&numeroUsuarios); /* Retorna un vector dinámico de usuarios */

	if (numeroUsuarios == 0) {
		printf("\n\tNo existe ningun usuario registrado!\n");

	}
	else {
		printf("\n\t\t    ==> LISTADO DE JUGADORES <==\n");
		printf(" ------------------------------------------------------------------------------\n");
		printf("%10s%25s%25s\n", "#", "NOMBRE", "CONTRASEÑA");
		printf(" ------------------------------------------------------------------------------\n");

		/* Se recorre el vector dinámico de productos */
		for (i = 0; i < numeroUsuarios; i++) {
			printf("%10d%25s%25s\n", (i + 1), usuarios[i].nombre, usuarios[i].password);
		}
		printf(" ------------------------------------------------------------------------------\n");
	}

	// Se libera la memoria asignada al vector dinámico
	free(usuarios);
	usuarios = NULL;
	getchar();
}

void menuIniciarSesion() {


	char nombreUsuario[MAX];
	char password[MAX];
	int intento = 0;
	int loginExitoso = 0;

	do {
		system("cls");
		printf("\n\t\t\tINGRESAR AL SISTEMA\n");
		printf("\t\t\t===================\n");

		printf("\n\t\tUSUARIO: ");
		leerLinea(linea, MAX);
		sscanf(linea, "%s", nombreUsuario);

		printf("\t\tCLAVE: ");
		leerClave(password);

		if (logear(nombreUsuario, password)) {
			loginExitoso = 1;
		}
		else {
			printf("\n\n\t\tUsuario y/o password incorrectos");
			intento++;
			getchar();
		}
	} while (intento < MAX_INTENTOS && loginExitoso == 0);

	if (loginExitoso == 1) {
		menuSistema();

	}
	else {
		printf("\n\tHa sobrepasado el numero maximo de intentos permitidos\n");
		getchar();
	}
}

int banner() {
	printf("*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*\n");
	char banner[] = { "*-*-*-*-{ WOMBAT YINCANA }-*-*-*-*-*-{ WOMBAT YINCANA }-*-*-*-*-*{ WOMBAT YINCANA }-*-*-*-*" };
	unsigned short longitud, indice, espacio, repite, resto;

	//A CONTINUACION SE PROGRAMA EL BANNER

	longitud = strlen(banner);
	for (repite = 1; repite <= 2; repite++) /* repite el proceso 3 veces */
	{
		// ******** IMPRIME EN ORDEN DE IZQUIERDA A DERECHA Y LUEGO DESPLAZA ******** 
		for (resto = 0; resto <= longitud; resto++) // para caracteres restantes a imprimir 
		{
			for (indice = 0; indice <= longitud - 1 - resto; indice++) // seleccion de indices evitando restantes 
			{
				printf("%c", banner[indice]); // imprime indice 
				if (!resto) usleep(1000); // demora el proceso 
			}
			for (espacio = 1; espacio <= longitud - resto - 1; espacio++)
				printf("\b"); // retrocede 

			if (resto) usleep(2000); // demora el proceso 
			printf("\b "); // borra el caracter actual 
		}

		for (espacio = 1; espacio <= longitud; espacio++) // borra todos los caracteres presentados 
			printf("\b\b ");
		printf("\b"); // se coloca al inicio del desplegado
	}
	printf("*-*-*-*-{ WOMBAT YINCANA }-*-*-*-*-*-{ WOMBAT YINCANA }-*-*-*-*-*{ WOMBAT YINCANA }-*-*-*-*\n");
	printf("*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*\n");

}

//INTRODUCIMOS LA FUNCIÓN DE UN BANNER FIJO 

int banner_fijo() {
	printf("*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*\n");
	printf("*-*-*-*-*-*-*-{ WOMBAT YINCANA }-*-*-*-*-*-{ WOMBAT YINCANA }-*-*-*-*-*{ WOMBAT YINCANA }-*-*-*-*-*-*\n");
	printf("*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*\n");

}

//INTRODUCIMOS LA FUNCION PARA EL VIDEOJUEGO

void menuSistema() {

	int q, i, dificultad_escogida, NUM_PREGUNTAS, respuesta;


	system("cls");
	banner_fijo();
	printf("\n     =========================================================================\n");
	printf("\t\t\t     BIENVENIDO A LA MADRIGUERA\n");
	printf("\t\t  Deberemos resolver preguntas matematicas para asi conseguir\n");
	printf("\t\t   que nuestro amigo el wombat consiga salir a la superficie\n");

	printf("     =========================================================================\n");

	printf("\n\t\t Aqui va todo el contenido de tu sistema ;)");

	struct jugador PLAYER[4];
	
	
	int num_jugadores;
	banner_fijo();

	for (i = 0; i < num_jugadores; i++) {
		PLAYER[i].dificultad = dificultad_escogida;
	}
	system("pause");

	// INICIAR EL JUEGO AQUI.

	for (i = 0; i < num_jugadores; i++) {
		int j = 0, solucionario;

		if (PLAYER[i].dificultad == 1) {
			// Abrimos aquí la dificultad de fácil.
			for (j = 0; j < NUM_PREGUNTAS; j++) {

				preguntas_facil(PLAYER[i].pregunta_actual);

				printf("\nRespuesta:");
				scanf("%d", &respuesta);

				solucionario = respuestas_facil(PLAYER[i].pregunta_actual, respuesta);
				if (solucionario == 1) {
					PLAYER[i].puntuacionjugador += 10;
					i++;
				}

				PLAYER[i].pregunta_actual += 1;
				system("pause");
			}

			if (PLAYER[i].pregunta_actual == 20) {
				printf("\nEs el turno del siguiente jugador.\n\n%cPreparado, jugador %s?", 168, PLAYER[i + 1].nombre_jugador);
			}

		}
		else {
			// Abrimos aquí la dificultad dificil.	
			if (PLAYER[i].dificultad == 1) {

				for (j = 0; j < NUM_PREGUNTAS; j++) {

					preguntas_dificil(PLAYER[i].pregunta_actual);

					printf("\nRespuesta:");
					scanf("%d", &respuesta);

					solucionario = respuestas_dificil(PLAYER[i].pregunta_actual, respuesta);
					if (solucionario == 1) {
						PLAYER[i].puntuacionjugador += 10;
					}

					PLAYER[i].pregunta_actual += 1;
					system("pause");
				}

				if (PLAYER[i].pregunta_actual == 20) {
					printf("\nEs el turno del siguiente jugador.\n\n%cPreparado, jugador %s?", 168, PLAYER[i + 1].nombre_jugador);
				}

			}

			// Aquí recogemos los datos uno a uno de los jugadores según vayan acabando. Quita el comentario para probar que compila.
			// recoger_datos(PLAYER[i].nombre_jugador, PLAYER[i].dificultad, PLAYER[i].puntuacionjugador);


		}

		// Aquí se ha acabado el juego y recogemos los datos de los jugadores 

		getchar();
	}

}
